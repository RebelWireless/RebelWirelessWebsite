{% extends "base.html" %}

{% block content %}
<section class="bg-black py-16 px-4 lg:py-24">
  <div class="max-w-screen-xl mx-auto">

    <!-- Section Header -->
    <div class="max-w-screen-md mx-auto text-center mb-12">
      <h1 class="text-4xl font-extrabold text-white mb-4">
        Check Coverage
      </h1>
      <p class="text-gray-400 text-lg">
        See where Rebel Wireless service is currently available.
      </p>
    </div>

    <!-- Search Box -->
    <div class="max-w-md mx-auto mb-8">
      <input
        id="coverageSearch"
        type="text"
        placeholder="Enter building, city, or address"
        class="w-full px-4 py-3 rounded-lg bg-zinc-900 border border-zinc-800 text-white placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-red-900 transition"
      />
    </div>

    <!-- Map -->
    <div class="bg-zinc-900 border border-zinc-800 rounded-lg shadow overflow-hidden mb-12">
      <div id="coverageMap" class="w-full h-[500px]"></div>
    </div>

    <!-- Coverage Table -->
    <div class="relative overflow-x-auto bg-zinc-900 border border-zinc-800 rounded-lg shadow">
      <table class="w-full text-sm text-left text-gray-300">
        <caption class="p-6 text-lg font-bold text-white">
          Service Availability
          <p class="mt-2 text-sm font-normal text-gray-400">
            All currently known serviceable and expansion locations.
          </p>
        </caption>

        <thead class="bg-zinc-800 border-t border-b border-zinc-700 text-gray-400">
          <tr>
            <th class="px-6 py-3">Location</th>
            <th class="px-6 py-3">Service Types</th>
            <th class="px-6 py-3">Max Speed</th>
            <th class="px-6 py-3 text-right">Action</th>
          </tr>
        </thead>

        <tbody id="coverageTableBody"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between mt-6">
      <button
        id="prevPage"
        class="border border-red-600 text-red-500 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg transition disabled:opacity-40"
      >
        Previous
      </button>

      <p class="text-gray-400 text-sm">
        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
      </p>

      <button
        id="nextPage"
        class="border border-red-600 text-red-500 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg transition disabled:opacity-40"
      >
        Next
      </button>
    </div>

  </div>
</section>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const locations = {{ locations | tojson }};
  let markers = [];

  /* ================= MAP ================= */
  const map = L.map("coverageMap");

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  function renderMarkers(locationsToShow) {
    // Clear existing markers
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const latLngs = [];

    locationsToShow.forEach(loc => {
      if (!loc.lat || !loc.lng) return;
      const marker = L.marker([loc.lat, loc.lng]).addTo(map);
      marker.bindPopup(`<strong>${loc.name}</strong>`);
      markers.push(marker);
      latLngs.push([loc.lat, loc.lng]);
    });

    if (latLngs.length > 0) {
      map.fitBounds(latLngs, { padding: [50, 50] });
    } else {
      map.setView([55.0902, -100.7129], 4);
    }
  }

  /* ================= TABLE + PAGINATION ================= */
  const tableBody = document.getElementById("coverageTableBody");
  const prevBtn = document.getElementById("prevPage");
  const nextBtn = document.getElementById("nextPage");
  const currentPageEl = document.getElementById("currentPage");
  const totalPagesEl = document.getElementById("totalPages");

  const rowsPerPage = 5;
  let currentPage = 1;
  let filteredLocations = [...locations];

  function renderTable() {
    tableBody.innerHTML = "";
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageItems = filteredLocations.slice(start, end);

    let html = "";

    if (pageItems.length === 0) {
      html = `
        <tr>
          <td colspan="4" class="px-6 py-4 text-center text-gray-400">
            No results found.
          </td>
        </tr>
      `;
    } else {
      pageItems.forEach(loc => {
        const available = loc.service_types && loc.service_types.length > 0;
        html += `
          <tr class="border-b border-zinc-800 hover:bg-zinc-800/50 transition">
            <td class="px-6 py-4 font-semibold text-white">${loc.name}</td>
            <td class="px-6 py-4">${available ? loc.service_types.join(", ") : "Not Available"}</td>
            <td class="px-6 py-4">${available ? loc.max_speed : "â€”"}</td>
            <td class="px-6 py-4 text-right">
              ${
                available
                  ? `<a href="/signup?location=${encodeURIComponent(loc.name)}"
                       class="bg-red-600 hover:bg-red-500 text-white font-semibold px-4 py-2 rounded-lg transition">
                       Sign Up
                     </a>`
                  : `<a href="/contact"
                       class="text-red-500 hover:text-red-400 font-medium">
                       Contact Us
                     </a>`
              }
            </td>
          </tr>
        `;
      });
    }

    tableBody.innerHTML = html;

    const totalPages = Math.ceil(filteredLocations.length / rowsPerPage) || 1;
    currentPageEl.textContent = currentPage;
    totalPagesEl.textContent = totalPages;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;

    renderMarkers(filteredLocations);
  }

  prevBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  });

  nextBtn.addEventListener("click", () => {
    const totalPages = Math.ceil(filteredLocations.length / rowsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
    }
  });

  /* ================= SEARCH ================= */
  document.getElementById("coverageSearch").addEventListener("input", e => {
    const query = e.target.value.toLowerCase().trim();

    filteredLocations = locations.filter(loc =>
      loc.name.toLowerCase().includes(query) ||
      (loc.address && loc.address.toLowerCase().includes(query)) ||
      (loc.city && loc.city.toLowerCase().includes(query))
    );

    currentPage = 1;
    renderTable();
  });

  renderTable();
</script>
{% endblock %}
